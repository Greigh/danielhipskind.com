<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - Daniel Hipskind</title>
    <link rel="stylesheet" href="/admin/admin-framework.css" />
    <style>
      /* Dashboard specific styles */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--admin-space-lg);
        margin-bottom: var(--admin-space-lg);
      }

      .metrics-preview {
        background: var(--admin-card-bg);
        border-radius: var(--admin-radius-lg);
        padding: var(--admin-space-lg);
        box-shadow: var(--admin-shadow-md);
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--admin-space-sm);
        margin-top: var(--admin-space-md);
      }

      .metric-item {
        text-align: center;
        padding: var(--admin-space-sm);
        background: var(--admin-primary-light);
        border-radius: var(--admin-radius-md);
      }

      .metric-value {
        font-size: var(--admin-font-xl);
        font-weight: 700;
        color: var(--admin-primary);
        margin-bottom: var(--admin-space-xs);
      }

      .metric-label {
        font-size: var(--admin-font-xs);
        color: var(--admin-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--admin-space-sm);
        margin-top: var(--admin-space-md);
      }

      .action-section h4 {
        margin: 0 0 var(--admin-space-md) 0;
        color: var(--admin-text);
        font-size: var(--admin-font-lg);
      }

      .auto-refresh-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--admin-space-xs);
        font-size: var(--admin-font-sm);
        color: var(--admin-text-secondary);
        margin-left: var(--admin-space-sm);
      }

      .refresh-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--status-success);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="admin-body">
    <div class="admin-container">
      <!-- Breadcrumb Navigation -->
      <nav class="admin-breadcrumbs">
        <a href="/">ğŸ  Home</a>
        <span class="separator">â†’</span>
        <span>Admin Dashboard</span>
      </nav>

      <!-- Header -->
      <header class="admin-header">
        <h1>ğŸš€ Admin Control Center</h1>
        <p>
          Comprehensive monitoring and administration for danielhipskind.com
        </p>
        <div class="auto-refresh-indicator">
          <div class="refresh-dot"></div>
          Auto-refresh enabled
        </div>
      </header>

      <!-- Real-time System Status -->
      <section class="admin-card admin-mb-lg">
        <div class="admin-p-lg">
          <h3
            style="
              margin: 0 0 var(--admin-space-md) 0;
              color: var(--admin-text);
            "
          >
            ğŸ”§ System Status
            <span
              id="last-update"
              class="admin-text-secondary"
              style="font-size: var(--admin-font-sm)"
            ></span>
          </h3>
          <div class="admin-status-grid">
            <div class="admin-status-card" id="auth-status">
              <div class="admin-status-label">Authentication</div>
              <div class="admin-status-value">Checking...</div>
            </div>
            <div class="admin-status-card" id="server-status">
              <div class="admin-status-label">Server Status</div>
              <div class="admin-status-value">Checking...</div>
            </div>
            <div class="admin-status-card" id="redis-status">
              <div class="admin-status-label">Redis Status</div>
              <div class="admin-status-value">Checking...</div>
            </div>
            <div class="admin-status-card" id="health-status">
              <div class="admin-status-label">Health Score</div>
              <div class="admin-status-value">Checking...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Analytics Preview -->
        <section class="metrics-preview">
          <h4
            style="
              margin: 0 0 var(--admin-space-sm) 0;
              color: var(--admin-text);
            "
          >
            ğŸ“Š Analytics Overview
          </h4>
          <p
            style="
              color: var(--admin-text-secondary);
              margin: 0 0 var(--admin-space-md) 0;
              font-size: var(--admin-font-sm);
            "
          >
            Recent activity metrics
          </p>
          <div class="metrics-grid" id="analytics-metrics">
            <div class="metric-item">
              <div class="metric-value" id="total-events">-</div>
              <div class="metric-label">Events</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="unique-visitors">-</div>
              <div class="metric-label">Visitors</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="page-views">-</div>
              <div class="metric-label">Page Views</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="avg-session">-</div>
              <div class="metric-label">Avg Session</div>
            </div>
          </div>
        </section>

        <!-- Quick Actions -->
        <section class="metrics-preview">
          <h4
            style="
              margin: 0 0 var(--admin-space-sm) 0;
              color: var(--admin-text);
            "
          >
            âš¡ Quick Actions
          </h4>
          <p
            style="
              color: var(--admin-text-secondary);
              margin: 0 0 var(--admin-space-md) 0;
              font-size: var(--admin-font-sm);
            "
          >
            Common administrative tasks
          </p>
          <div class="quick-actions">
            <button class="admin-btn admin-btn-sm" onclick="clearGitHubCache()">
              ğŸ—‘ï¸ Clear Cache
            </button>
            <button
              class="admin-btn admin-btn-sm admin-btn-secondary"
              onclick="refreshDashboard()"
            >
              ğŸ”„ Refresh All
            </button>
            <button
              class="admin-btn admin-btn-sm admin-btn-warning"
              onclick="exportLogs()"
            >
              ğŸ“ Export Logs
            </button>
            <button
              class="admin-btn admin-btn-sm admin-btn-success"
              onclick="testEndpoints()"
            >
              ğŸ” Test APIs
            </button>
          </div>
        </section>
      </div>

      <!-- Navigation Grid -->
      <section class="admin-mb-lg">
        <h3
          style="margin: 0 0 var(--admin-space-md) 0; color: var(--admin-text)"
        >
          ğŸ§­ Administration Tools
        </h3>
        <div class="admin-nav-grid">
          <a href="/admin/analytics.html" class="admin-nav-card">
            <h3>ğŸ“Š Analytics Dashboard</h3>
            <p>
              Comprehensive analytics with filtering, real-time metrics, and
              export capabilities. View user behavior, traffic patterns, and
              system usage.
            </p>
          </a>

          <a href="/health-dashboard" class="admin-nav-card" target="_blank">
            <h3>ğŸ¥ Health Dashboard</h3>
            <p>
              Real-time system health monitoring with auto-refresh. Monitor
              server status, memory usage, uptime, and performance metrics.
            </p>
          </a>

          <a href="/admin/login.html" class="admin-nav-card">
            <h3>ğŸ” Authentication</h3>
            <p>
              Secure admin login system with session management. Authenticate
              with admin credentials to access protected endpoints.
            </p>
          </a>

          <a href="/admin/logs.html" class="admin-nav-card">
            <h3>ğŸ“‹ System Logs</h3>
            <p>
              View and manage server logs, error reports, and system events.
              Real-time log monitoring with filtering and export capabilities.
            </p>
          </a>

          <a
            href="/api/admin/analytics?limit=10"
            class="admin-nav-card"
            target="_blank"
          >
            <h3>ğŸ”§ API Explorer</h3>
            <p>
              Direct access to admin API endpoints for testing and debugging.
              Explore analytics data and system status programmatically.
            </p>
          </a>

          <a
            href="https://github.com/Greigh/danielhipskind.com"
            class="admin-nav-card"
            target="_blank"
          >
            <h3>ğŸ’» Repository</h3>
            <p>
              Access the source code repository, view commits, and manage
              deployments through GitHub integration.
            </p>
          </a>
        </div>
      </section>

      <!-- Footer -->
      <footer
        style="
          text-align: center;
          color: var(--admin-text-secondary);
          margin-top: var(--admin-space-xl);
        "
      >
        <p>
          <a href="/" class="admin-btn admin-btn-secondary admin-btn-sm"
            >â† Back to Main Site</a
          >
          <a
            href="/admin/login.html"
            class="admin-btn admin-btn-sm"
            style="margin-left: var(--admin-space-sm)"
            >ğŸ” Login</a
          >
        </p>
        <p
          style="
            margin-top: var(--admin-space-sm);
            font-size: var(--admin-font-sm);
          "
        >
          Last updated: <span id="dashboard-timestamp">-</span>
        </p>
      </footer>
    </div>

    <!-- JavaScript for Enhanced Dashboard -->
    <script>
      let refreshInterval;
      let lastUpdateTime = new Date();

      // Enhanced status checking with health metrics
      async function checkAuthStatus() {
        const token = sessionStorage.getItem('admin_token');
        const authStatus = document.getElementById('auth-status');

        if (token) {
          authStatus.className = 'admin-status-card success';
          authStatus.querySelector('.admin-status-value').textContent =
            'Authenticated';
        } else {
          authStatus.className = 'admin-status-card warning';
          authStatus.querySelector('.admin-status-value').textContent =
            'Not Logged In';
        }
      }

      // Enhanced server status with more metrics
      async function checkServerStatus() {
        const serverStatus = document.getElementById('server-status');
        try {
          const response = await fetch('/api/status');
          if (response.ok) {
            const data = await response.json();
            serverStatus.className = 'admin-status-card success';
            serverStatus.querySelector('.admin-status-value').textContent =
              'Online';
          } else {
            serverStatus.className = 'admin-status-card error';
            serverStatus.querySelector('.admin-status-value').textContent =
              'Error';
          }
        } catch (error) {
          serverStatus.className = 'admin-status-card error';
          serverStatus.querySelector('.admin-status-value').textContent =
            'Offline';
        }
      }

      // Enhanced Redis status
      async function checkRedisStatus() {
        const redisStatus = document.getElementById('redis-status');
        const token = sessionStorage.getItem('admin_token');

        if (!token) {
          redisStatus.className = 'admin-status-card warning';
          redisStatus.querySelector('.admin-status-value').textContent =
            'Need Auth';
          return;
        }

        try {
          const tokenIsCookie = token === 'cookie';
          const fetchOpts = tokenIsCookie
            ? { credentials: 'include' }
            : { headers: { Authorization: 'Bearer ' + token } };

          const response = await fetch(
            '/api/admin/analytics?limit=1',
            fetchOpts
          );

          if (response.ok) {
            const data = await response.json();
            if (data.source === 'redis') {
              redisStatus.className = 'admin-status-card success';
              redisStatus.querySelector('.admin-status-value').textContent =
                'Connected';
            } else {
              redisStatus.className = 'admin-status-card warning';
              redisStatus.querySelector('.admin-status-value').textContent =
                'Fallback Mode';
            }
          } else {
            redisStatus.className = 'admin-status-card error';
            redisStatus.querySelector('.admin-status-value').textContent =
              'Error';
          }
        } catch (error) {
          redisStatus.className = 'admin-status-card error';
          redisStatus.querySelector('.admin-status-value').textContent =
            'Unknown';
        }
      }

      // New health status check
      async function checkHealthStatus() {
        const healthStatus = document.getElementById('health-status');
        try {
          const response = await fetch('/health');
          if (response.ok) {
            const data = await response.json();
            const score = calculateHealthScore(data);
            healthStatus.className = `admin-status-card ${getHealthClass(
              score
            )}`;
            healthStatus.querySelector('.admin-status-value').textContent =
              score + '%';
          } else {
            healthStatus.className = 'admin-status-card error';
            healthStatus.querySelector('.admin-status-value').textContent =
              'Error';
          }
        } catch (error) {
          healthStatus.className = 'admin-status-card error';
          healthStatus.querySelector('.admin-status-value').textContent =
            'Offline';
        }
      }

      // Calculate health score from health data
      function calculateHealthScore(data) {
        let score = 100;

        // Deduct for high memory usage (>80%)
        if (data.memory && data.memory.used / data.memory.total > 0.8) {
          score -= 20;
        }

        // Deduct for high load average
        if (data.system && data.system.loadavg && data.system.loadavg[0] > 2) {
          score -= 15;
        }

        // Deduct for errors
        if (data.status !== 'ok') {
          score -= 30;
        }

        return Math.max(0, Math.min(100, score));
      }

      // Get health status class
      function getHealthClass(score) {
        if (score >= 80) return 'success';
        if (score >= 60) return 'warning';
        return 'error';
      }

      // Load analytics preview
      async function loadAnalyticsPreview() {
        const token = sessionStorage.getItem('admin_token');
        if (!token) return;

        try {
          const tokenIsCookie = token === 'cookie';
          const fetchOpts = tokenIsCookie
            ? { credentials: 'include' }
            : { headers: { Authorization: 'Bearer ' + token } };

          const response = await fetch(
            '/api/admin/analytics?limit=100',
            fetchOpts
          );

          if (response.ok) {
            const data = await response.json();
            updateAnalyticsMetrics(data.events || []);
          }
        } catch (error) {
          console.error('Analytics preview error:', error);
        }
      }

      // Update analytics metrics display
      function updateAnalyticsMetrics(events) {
        document.getElementById('total-events').textContent = events.length;

        const uniqueIPs = new Set(events.map((e) => e.ip)).size;
        document.getElementById('unique-visitors').textContent = uniqueIPs;

        const pageViews = events.filter((e) => e.event === 'pageview').length;
        document.getElementById('page-views').textContent = pageViews;

        // Calculate average session length (simplified)
        const sessions = groupEventsBySession(events);
        const avgSession =
          sessions.length > 0
            ? Math.round(
                sessions.reduce((sum, s) => sum + s.duration, 0) /
                  sessions.length /
                  1000
              )
            : 0;
        document.getElementById('avg-session').textContent = avgSession + 's';
      }

      // Group events by session (simplified - by IP and time proximity)
      function groupEventsBySession(events) {
        const sessions = [];
        const ipSessions = {};

        events.forEach((event) => {
          const ip = event.ip;
          const time = new Date(event.timestamp).getTime();

          if (!ipSessions[ip]) {
            ipSessions[ip] = { start: time, end: time, duration: 0 };
          } else {
            if (time - ipSessions[ip].end < 30 * 60 * 1000) {
              // 30 min session timeout
              ipSessions[ip].end = time;
              ipSessions[ip].duration =
                ipSessions[ip].end - ipSessions[ip].start;
            } else {
              sessions.push(ipSessions[ip]);
              ipSessions[ip] = { start: time, end: time, duration: 0 };
            }
          }
        });

        Object.values(ipSessions).forEach((session) => sessions.push(session));
        return sessions;
      }

      // Quick action functions
      async function clearGitHubCache() {
        const token = sessionStorage.getItem('admin_token');
        if (!token) {
          alert('Please login first');
          return;
        }

        if (
          !confirm('Clear GitHub cache? This will refresh all repository data.')
        )
          return;

        try {
          const tokenIsCookie = token === 'cookie';
          const fetchOpts = {
            method: 'POST',
            ...(tokenIsCookie
              ? { credentials: 'include' }
              : { headers: { Authorization: 'Bearer ' + token } }),
          };

          const response = await fetch(
            '/api/admin/clear-github-cache',
            fetchOpts
          );

          if (response.ok) {
            alert('GitHub cache cleared successfully!');
          } else {
            alert('Failed to clear cache');
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      function refreshDashboard() {
        lastUpdateTime = new Date();
        updateTimestamp();
        checkAllSystems();
        loadAnalyticsPreview();
      }

      function exportLogs() {
        // Redirect to logs viewer
        window.location.href = '/admin/logs.html';
      }

      async function testEndpoints() {
        const endpoints = [
          '/health',
          '/api/status',
          '/api/admin/analytics?limit=1',
        ];
        const results = [];

        for (const endpoint of endpoints) {
          try {
            const response = await fetch(endpoint);
            results.push(
              `${endpoint}: ${response.status} ${response.ok ? 'âœ…' : 'âŒ'}`
            );
          } catch (error) {
            results.push(`${endpoint}: Error âŒ`);
          }
        }

        alert('Endpoint Test Results:\\n\\n' + results.join('\\n'));
      }

      // Check all systems
      function checkAllSystems() {
        checkAuthStatus();
        checkServerStatus();
        setTimeout(checkRedisStatus, 500);
        setTimeout(checkHealthStatus, 800);
      }

      // Update timestamp display
      function updateTimestamp() {
        document.getElementById('dashboard-timestamp').textContent =
          lastUpdateTime.toLocaleString();
        document.getElementById('last-update').textContent =
          '(Updated: ' + lastUpdateTime.toLocaleTimeString() + ')';
      }

      // Initialize dashboard with auto-refresh
      document.addEventListener('DOMContentLoaded', () => {
        checkAllSystems();
        loadAnalyticsPreview();
        updateTimestamp();

        // Set up auto-refresh every 30 seconds
        refreshInterval = setInterval(() => {
          refreshDashboard();
        }, 30000);
      });

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
      });
    </script>
  </body>
</html>
